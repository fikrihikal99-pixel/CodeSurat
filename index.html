<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Generator Nomor Surat ‚Äî SD (Online History)</title>
  <style>
    :root{ --bg:#f7fafc; --card:#ffffff; --accent:#2563eb; --muted:#6b7280; --radius:10px; }
    body{ margin:0; font-family:Inter, "Segoe UI", Roboto, Arial; background:var(--bg); color:#0f172a; padding:20px; }
    .container{ max-width:1040px; margin:0 auto; }
    .card{ background:var(--card); border-radius:12px; padding:18px; box-shadow:0 6px 20px rgba(15,23,42,0.06); margin-bottom:16px; }
    h1{ margin:0 0 6px 0; font-size:18px; }
    p.lead{ margin:0 0 12px 0; color:var(--muted); font-size:13px; }
    label{ display:block; font-weight:600; margin-top:10px; font-size:13px; }
    .flex{ display:flex; gap:12px; align-items:center; }
    .row{ display:flex; gap:12px; margin-top:8px; flex-wrap:wrap; }
    input[type="text"], input[type="number"], select, textarea{ width:100%; padding:8px 10px; border-radius:8px; border:1px solid #e6e9ef; font-size:14px; box-sizing:border-box; background:white; }
    .small{ font-size:13px; color:var(--muted); }
    .btn{ border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; }
    .btn-primary{ background:var(--accent); color:white; }
    .btn-ghost{ background:#eef2ff; color:var(--accent); border:1px solid rgba(37,99,235,0.12); }
    .btn-muted{ background:#f1f5f9; color:#0f172a; }
    .nbtn{ width:38px; height:38px; border-radius:8px; border:0; background:var(--accent); color:white; font-size:18px; cursor:pointer; }
    .kode-list{ max-height:240px; overflow:auto; margin-top:8px; border:1px solid #eef2ff; border-radius:8px; padding:6px; background:#fff; }
    .kode-item{ padding:8px; border-radius:6px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .kode-item:hover{ background:#f8fafc; }
    .kode-selected{ background:#eef2ff; border-left:4px solid var(--accent); }
    .preview{ margin-top:12px; padding:12px; border-radius:8px; background:#0f172a; color:white; font-family:Georgia, 'Times New Roman', serif; }
    .preview .big{ font-size:16px; font-weight:700; }
    textarea#hasil{ height:56px; resize:vertical; }
    .controls{ display:flex; gap:8px; margin-top:10px; align-items:center; flex-wrap:wrap; }
    .footnote{ margin-top:8px; font-size:12px; color:var(--muted); }
    .history-list{ margin-top:12px; }
    .history-item{ background:#fff; border:1px solid #eef2ff; padding:10px; border-radius:8px; display:flex; justify-content:space-between; gap:8px; align-items:flex-start; margin-bottom:8px; }
    .hist-left{ max-width:73%; }
    .hist-right{ display:flex; gap:8px; align-items:center; }
    .muted-block{ color:var(--muted); font-size:13px; margin-top:6px; }
    .tiny{ font-size:12px; color:var(--muted); }
    .danger{ background:#fee2e2; color:#b91c1c; padding:6px 8px; border-radius:6px; border:0; cursor:pointer; }
    @media (max-width:800px){ .row{ flex-direction:column; } .hist-left{ max-width:100%; } .kode-list{ max-height:160px; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Generator Nomor Surat ‚Äî SDN CILUAR 1 (Online History)</h1>
      <p class="lead">Format: <code>KODE/NOMOR/NAMA SEKOLAH/BULAN_ROMAWI/TAHUN</code>. Riwayat tersimpan online ke Google Sheet.</p>

      <!-- Search + Kode list -->
      <label for="searchKode">Cari Kode Surat (ketik kata kunci atau kode)</label>
      <div class="flex">
        <input id="searchKode" type="text" placeholder="Contoh: guru, keuangan, 421.2, kesiswaan..." />
        <button id="clearSearch" class="btn btn-ghost">Clear</button>
      </div>

      <div style="display:flex; gap:12px; margin-top:8px;">
        <div style="flex:1">
          <label>Kode Surat (pilih)</label>
          <div id="kodeList" class="kode-list" role="listbox" aria-label="Daftar kode surat"></div>
        </div>

        <div style="width:340px;">
          <label>Keterangan Kode</label>
          <div id="kodeDesc" style="padding:10px;border-radius:8px;background:#fbfdff;border:1px solid #eef2ff;min-height:68px;">Pilih kode untuk melihat keterangan.</div>
        </div>
      </div>

      <!-- Nomor + Sekolah + Bulan + Tahun -->
      <label>Nomor Surat</label>
      <div class="row" style="align-items:flex-start;">
        <div style="width:180px;">
          <div class="flex" style="align-items:center;">
            <button id="minusBtn" class="nbtn" title="Kurangi">‚àí</button>
            <input id="nomorInput" type="number" min="1" value="1" style="text-align:center;width:100px;"/>
            <button id="plusBtn" class="nbtn" title="Tambah">+</button>
          </div>
          <div class="small" style="margin-top:6px;">Nomor disimpan otomatis per kombinasi kode+sekolah+tahun.</div>
        </div>

        <div style="flex:1;">
          <label>Nama Sekolah</label>
          <select id="sekolahSelect">
            <option value="SDNCIL1">SDNCIL1</option>
            <option value="LAINNYA">-- Isi Manual --</option>
          </select>
          <input id="sekolahCustom" type="text" placeholder="Isi nama sekolah jika pilih '-- Isi Manual --'" style="margin-top:8px; display:none;" />
        </div>

        <div style="width:170px;">
          <label>Bulan</label>
          <select id="bulanSelect">
            <option value="I">I ‚Äî Januari</option>
            <option value="II">II ‚Äî Februari</option>
            <option value="III">III ‚Äî Maret</option>
            <option value="IV">IV ‚Äî April</option>
            <option value="V">V ‚Äî Mei</option>
            <option value="VI">VI ‚Äî Juni</option>
            <option value="VII">VII ‚Äî Juli</option>
            <option value="VIII">VIII ‚Äî Agustus</option>
            <option value="IX">IX ‚Äî September</option>
            <option value="X">X ‚Äî Oktober</option>
            <option value="XI">XI ‚Äî November</option>
            <option value="XII">XII ‚Äî Desember</option>
          </select>
        </div>

        <div style="width:140px;">
          <label>Tahun</label>
          <input id="tahunInput" type="number" min="1900" max="3000" />
        </div>
      </div>

      <!-- Controls -->
      <div class="controls">
        <button id="generateBtn" class="btn btn-primary">Generate</button>
        <button id="copyBtn" class="btn btn-ghost">Copy</button>
        <button id="resetBtn" class="btn btn-muted">Reset</button>
        <div style="flex:1"></div>
        <div class="tiny" id="statusSaved" aria-live="polite"></div>
      </div>

      <label style="margin-top:12px;">Hasil Nomor Surat</label>
      <textarea id="hasil" readonly placeholder="Hasil akan muncul di sini..."></textarea>

      <div class="preview" id="previewArea" style="display:none;">
        <div class="big" id="previewNumber">421.2/01/SDNCIL1/X/2025</div>
        <div class="muted-block" id="previewMeta">SDNCIL1 ‚Äî Kode 421.2 (Sekolah Dasar) ‚Äî dibuat: <span id="previewCreated"></span></div>
        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.08);margin:8px 0;">
        <div style="font-size:14px;line-height:1.4;">
          <div style="text-align:center;font-weight:700;">SURAT DINAS</div>
          <div style="text-align:center;margin-top:6px;font-size:13px;">Nomor: <span id="previewNumberInline"></span></div>
          <div style="margin-top:8px;font-size:13px;">Perihal: <span id="previewPerihal">[Isikan perihal jika perlu]</span></div>
          <div style="margin-top:6px;font-size:13px;">Keterangan kode: <span id="previewKet"></span></div>
        </div>
      </div>
    </div>

    <!-- History Card -->
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0;font-size:16px;">Riwayat Nomor Surat</h2>
          <div class="small">Riwayat online tersimpan di Google Sheet. Juga disimpan lokal sebagai cache.</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button id="loadOnlineBtn" class="btn btn-primary">üîÑ Muat Riwayat Online</button>
          <button id="copyAllHistoryBtn" class="btn btn-ghost">üìã Salin Semua</button>
          <button id="clearHistoryBtn" class="btn danger">üóëÔ∏è Hapus Riwayat Lokal</button>
        </div>
      </div>

      <div id="historyContainer" class="history-list" style="margin-top:12px;"></div>
      <div id="noHistoryMsg" class="small" style="margin-top:8px; color:var(--muted); display:none;">Belum ada riwayat.</div>

      <div style="margin-top:12px;">
        <label>Nama Pembuat (opsional)</label>
        <input id="pembuatInput" type="text" placeholder="Nama Anda, mis. Kepala Sekolah / Admin" />
      </div>
    </div>
  </div>

  <script>
  // =====================================
  // DATA KODE KLASIFIKASI ARSIP SEKOLAH DASAR
  // Berdasarkan Perwali Kota Bogor No.22 Tahun 2023
  // =====================================
  const kodeData = [
  // =====================================
  // KODE 000 ‚Äî URUSAN UMUM
  // =====================================
  { kode: "000", ket: "Urusan Umum" },
  { kode: "000.1", ket: "Ketatausahaan" },
  { kode: "000.1.1", ket: "Persuratan / Tata Naskah Dinas" },
  { kode: "000.1.2", ket: "Pengelolaan Surat Masuk dan Keluar" },
  { kode: "000.1.3", ket: "Pengelolaan Buku Agenda" },
  { kode: "000.1.4", ket: "Distribusi dan Ekspedisi Surat" },
  { kode: "000.1.5", ket: "Penomoran Surat" },
  { kode: "000.2", ket: "Kerumahtanggaan" },
  { kode: "000.2.1", ket: "Kebersihan dan Keindahan" },
  { kode: "000.2.2", ket: "Keamanan dan Ketertiban" },
  { kode: "000.2.3", ket: "Piket dan Jadwal Petugas" },
  { kode: "000.3", ket: "Perlengkapan" },
  { kode: "000.3.1", ket: "Pengadaan Alat Tulis Kantor" },
  { kode: "000.3.2", ket: "Pengadaan Barang / Jasa" },
  { kode: "000.3.3", ket: "Gudang dan Stok Barang" },
  { kode: "000.4", ket: "Perpustakaan" },
  { kode: "000.4.1", ket: "Pengadaan Buku" },
  { kode: "000.4.2", ket: "Katalog dan Klasifikasi Buku" },
  { kode: "000.4.3", ket: "Peminjaman dan Pengembalian Buku" },
  { kode: "000.5", ket: "Kearsipan" },
  { kode: "000.5.1", ket: "Arsip Dinamis" },
  { kode: "000.5.2", ket: "Arsip Inaktif" },
  { kode: "000.5.3", ket: "Pemusnahan Arsip" },
  { kode: "000.5.4", ket: "Penyerahan Arsip" },
  { kode: "000.6", ket: "Persandian" },
  { kode: "000.6.1", ket: "Keamanan Informasi" },
  { kode: "000.6.2", ket: "Penggunaan Kode / Sandi" },
  { kode: "000.7", ket: "Perencanaan" },
  { kode: "000.7.1", ket: "Rencana Kerja Tahunan" },
  { kode: "000.7.2", ket: "Program Kerja Sekolah" },
  { kode: "000.8", ket: "Organisasi dan Tata Kerja" },
  { kode: "000.8.1", ket: "Struktur Organisasi Sekolah" },
  { kode: "000.8.2", ket: "Tugas Pokok dan Fungsi" },
  { kode: "000.9", ket: "Penelitian dan Pengembangan" },

  // =====================================
  // KODE 100 ‚Äî PEMERINTAHAN SEKOLAH
  // =====================================
  { kode: "100", ket: "Pemerintahan dan Administrasi Resmi Sekolah" },
  { kode: "100.1", ket: "Kepala Sekolah" },
  { kode: "100.1.1", ket: "Kebijakan dan Arahan Kepala Sekolah" },
  { kode: "100.1.2", ket: "Surat Tugas Kepala Sekolah" },
  { kode: "100.1.3", ket: "Surat Rekomendasi Kepala Sekolah" },
  { kode: "100.2", ket: "Peraturan Sekolah" },
  { kode: "100.2.1", ket: "Tata Tertib Sekolah" },
  { kode: "100.2.2", ket: "Peraturan Akademik" },
  { kode: "100.2.3", ket: "Peraturan Ekstrakurikuler" },
  { kode: "100.2.4", ket: "Peraturan Kesiswaan" },
  { kode: "100.2.5", ket: "Peraturan Guru dan Pegawai" },
  { kode: "100.3", ket: "Hukum dan Perundangan" },
  { kode: "100.3.1", ket: "Peraturan Pemerintah Pendidikan" },
  { kode: "100.3.2", ket: "Peraturan Kemendikbud" },
  { kode: "100.3.3", ket: "Peraturan Daerah / Perwali" },
  { kode: "100.3.4", ket: "SOP / Juklak / Juknis" },
  { kode: "100.3.5", ket: "Instruksi / Edaran" },
  { kode: "100.3.6", ket: "SK Kepala Sekolah" },
  { kode: "100.3.7", ket: "Nota Dinas / Teguran" },
  { kode: "100.4", ket: "Kerja Sama & Kemitraan" },
  { kode: "100.4.1", ket: "MoU Sekolah" },
  { kode: "100.4.2", ket: "Kerja Sama Orang Tua / Komite" },
  { kode: "100.4.3", ket: "Kerja Sama Instansi Pemerintah" },
  { kode: "100.4.4", ket: "Kerja Sama Dunia Usaha" },
  { kode: "100.5", ket: "Administrasi Lembaga Sekolah" },
  { kode: "100.5.1", ket: "Pengajuan NPSN / Dapodik" },
  { kode: "100.5.2", ket: "Laporan ke Dinas Pendidikan" },
  { kode: "100.5.3", ket: "Akreditasi Sekolah" },
  { kode: "100.5.4", ket: "KTSP" },
  { kode: "100.6", ket: "Transparansi & Akuntabilitas" },
  { kode: "100.6.1", ket: "Laporan Penyelenggaraan Pendidikan" },
  { kode: "100.6.2", ket: "Publikasi Resmi Sekolah" },
  { kode: "100.7", ket: "Komite Sekolah" },
  { kode: "100.7.1", ket: "Program Komite" },
  { kode: "100.7.2", ket: "Laporan Komite" },
  { kode: "100.7.3", ket: "Rapat Komite" },

  // =====================================
  // KODE 200 ‚Äî HUMAS, ORGANISASI
  // =====================================
  { kode: "200", ket: "Organisasi, Komunikasi, Humas, Kemitraan" },
  { kode: "200.1", ket: "Organisasi Sekolah" },
  { kode: "200.1.1", ket: "Struktur Organisasi Sekolah" },
  { kode: "200.1.2", ket: "Tupoksi" },
  { kode: "200.2", ket: "Humas Sekolah" },
  { kode: "200.2.1", ket: "Website Sekolah" },
  { kode: "200.2.2", ket: "Media Sosial Sekolah" },
  { kode: "200.2.3", ket: "Dokumentasi Sekolah" },
  { kode: "200.3", ket: "Kerja Sama Sekolah" },
  { kode: "200.3.1", ket: "Kerjasama Komite" },
  { kode: "200.3.2", ket: "Kerjasama Orang Tua" },
  { kode: "200.3.3", ket: "Kerjasama Pemerintah" },
  { kode: "200.3.4", ket: "Kerjasama Dunia Usaha" },
  { kode: "200.4", ket: "Kebijakan Strategis Sekolah" },
  { kode: "200.4.1", ket: "Musyawarah Sekolah" },
  { kode: "200.4.2", ket: "Program Kerja Tahunan" },
  { kode: "200.5", ket: "Komunikasi Sekolah" },
  { kode: "200.5.1", ket: "Surat Edaran" },
  { kode: "200.5.2", ket: "Panggilan Orang Tua" },
  { kode: "200.6", ket: "Seremonial Sekolah" },
  { kode: "200.6.1", ket: "Upacara Nasional" },
  { kode: "200.6.2", ket: "Peringatan Keagamaan" },
  { kode: "200.6.3", ket: "Pentas Seni" },

  // =====================================
  // KODE 300 ‚Äî KEAMANAN SEKOLAH
  // =====================================
  { kode: "300", ket: "Keamanan, Ketertiban & Kebencanaan" },
  { kode: "300.1", ket: "Ketertiban Siswa & Guru" },
  { kode: "300.1.1", ket: "Pelanggaran Siswa" },
  { kode: "300.2", ket: "Keamanan Sekolah" },
  { kode: "300.2.1", ket: "Laporan Keamanan" },
  { kode: "300.3", ket: "Simulasi & Kesiapsiagaan Bencana" },
  { kode: "300.3.1", ket: "Simulasi Gempa & Kebakaran" },

  // =====================================
  // KODE 400 ‚Äî BIDANG PENDIDIKAN
  // =====================================
  { kode: "400", ket: "Bidang Pendidikan" },
  { kode: "400.3.5.1", ket: "Kurikulum & Bahan Ajar SD" },
  { kode: "400.3.5.1.1", ket: "RPP / Modul Ajar SD" },
  { kode: "400.3.5.2", ket: "Dana BOS SD" },
  { kode: "400.3.5.3", ket: "Bimtek Guru SD" },
  { kode: "400.3.5.4", ket: "Lomba Akademik & Non Akademik" },
  { kode: "400.3.11", ket: "Penilaian Akademik SD" },
  { kode: "400.3.12", ket: "Penilaian Non Akademik" },
  { kode: "400.3.13", ket: "Sarpras Pendidikan" },
  { kode: "400.4.2.1", ket: "Olahraga Pendidikan Dasar" },
  { kode: "400.5", ket: "Pramuka" },
  { kode: "400.6", ket: "Kebudayaan" },
  { kode: "400.7", ket: "Kesehatan Sekolah (UKS)" },

  // =====================================
  // KODE 500 ‚Äî SARANA PRASARANA
  // =====================================
  { kode: "500", ket: "Sarana dan Prasarana" },
  { kode: "500.1", ket: "Inventaris Barang" },
  { kode: "500.2", ket: "Pemeliharaan Gedung" },
  { kode: "500.3", ket: "Peralatan Pembelajaran" },

  // =====================================
  // KODE 600 ‚Äî LINGKUNGAN
  // =====================================
  { kode: "600", ket: "Ketertiban & Keamanan Umum" },
  { kode: "600.1", ket: "Koordinasi Lingkungan" },

  // =====================================
  // KODE 700 ‚Äî PUBLIKASI & INFORMASI
  // =====================================
  { kode: "700", ket: "Informasi, Dokumentasi, Publikasi" },
  { kode: "700.1", ket: "Website & Media Sekolah" },
  { kode: "700.2", ket: "Dokumentasi Foto & Video" },

  // =====================================
  // KODE 800 ‚Äî KEPEGAWAIAN
  // =====================================
  { kode: "800", ket: "Kepegawaian" },
  { kode: "800.1", ket: "Data Guru & Tendik" },
  { kode: "800.2", ket: "Absensi & Disiplin" },
  { kode: "800.3", ket: "Cuti Pegawai" },
  { kode: "800.4", ket: "Bimtek & KKG" },
  { kode: "800.5", ket: "Sertifikasi & Kenaikan Pangkat" },

  // =====================================
  // KODE 900 ‚Äî KEUANGAN
  // =====================================
  { kode: "900", ket: "Keuangan Sekolah" },
  { kode: "900.1", ket: "Dana BOS" },
  { kode: "900.2", ket: "SPJ & Laporan Keuangan" },
  { kode: "900.3", ket: "Dana Komite / Donasi" }
];

    // ================
    // Helpers & Elements
    // ================
    const $ = id => document.getElementById(id);
    const now = new Date();
    const defaultYear = now.getFullYear();
    const defaultMonthIndex = now.getMonth();

    function padTwo(n){ return String(n).padStart(2,'0'); }
    function formatIndoDate(isoString){
      const d = new Date(isoString);
      const opt = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
      return d.toLocaleDateString('id-ID', opt);
    }

    // elements
    const kodeListEl = $('kodeList');
    const kodeDescEl = $('kodeDesc');
    const searchEl = $('searchKode');
    const clearSearchBtn = $('clearSearch');
    const nomorInput = $('nomorInput');
    const minusBtn = $('minusBtn');
    const plusBtn = $('plusBtn');
    const bulanSelect = $('bulanSelect');
    const tahunInput = $('tahunInput');
    const sekolahSelect = $('sekolahSelect');
    const sekolahCustom = $('sekolahCustom');
    const generateBtn = $('generateBtn');
    const copyBtn = $('copyBtn');
    const resetBtn = $('resetBtn');
    const hasilEl = $('hasil');
    const previewArea = $('previewArea');
    const previewNumber = $('previewNumber');
    const previewNumberInline = $('previewNumberInline');
    const previewMeta = $('previewMeta');
    const previewCreated = $('previewCreated');
    const previewKet = $('previewKet');
    const statusSaved = $('statusSaved');

    const historyContainer = $('historyContainer');
    const clearHistoryBtn = $('clearHistoryBtn');
    const noHistoryMsg = $('noHistoryMsg');
    const loadOnlineBtn = $('loadOnlineBtn');
    const copyAllHistoryBtn = $('copyAllHistoryBtn');
    const pembuatInput = $('pembuatInput');

    // API URL (Apps Script) - GANTI jika perlu
    const API_URL = "https://script.google.com/macros/s/AKfycbx_us6kcd6rAIk8YjIhxpysE6ru8yYc6YZwdR2XhjCRVjDBWoiQZor9-S1zWRGHkFyjNQ/exec";

    // render kode list
    let kodeElements = [];
    function renderKodeList(list){
      kodeListEl.innerHTML = '';
      kodeElements = [];
      list.forEach(item => {
        const div = document.createElement('div');
        div.className = 'kode-item';
        div.tabIndex = 0;
        div.setAttribute('data-kode', item.kode);
        div.innerHTML = `<div><strong>${item.kode}</strong> <span style="color:#475569">‚Äî ${item.ket}</span></div>`;
        div.addEventListener('click', ()=> selectKode(item.kode));
        div.addEventListener('keydown', (e)=> { if(e.key==='Enter') selectKode(item.kode); });
        kodeListEl.appendChild(div);
        kodeElements.push({el:div, item});
      });
    }

    // state
    let selectedKode = null;

    function selectKode(kode){
      selectedKode = kode;
      kodeElements.forEach(k => {
        if(k.item.kode === kode) k.el.classList.add('kode-selected');
        else k.el.classList.remove('kode-selected');
      });
      const found = kodeData.find(x=>x.kode===kode);
      kodeDescEl.textContent = found ? found.ket : 'Tidak ada keterangan.'; 
      loadLastNumberForCurrentCombo();
      previewArea.style.display = 'none';
    }

    // initial render
    renderKodeList(kodeData);

    // search
    searchEl.addEventListener('input', ()=> {
      const q = searchEl.value.trim().toLowerCase();
      const filtered = kodeData.filter(k => (k.kode + ' ' + k.ket).toLowerCase().includes(q));
      renderKodeList(filtered);
      if(selectedKode){
        const still = filtered.find(f=>f.kode===selectedKode);
        if(still) selectKode(selectedKode);
      }
    });
    clearSearchBtn.addEventListener('click', ()=> { searchEl.value=''; searchEl.dispatchEvent(new Event('input')); });

    // sekolah custom toggle
    sekolahSelect.addEventListener('change', ()=>{ 
      if(sekolahSelect.value === 'LAINNYA'){ sekolahCustom.style.display = 'block'; sekolahCustom.focus(); } 
      else { sekolahCustom.style.display = 'none'; sekolahCustom.value = ''; }
      loadLastNumberForCurrentCombo();
    });

    // plus/minus
    plusBtn.addEventListener('click', ()=> { nomorInput.value = (Number(nomorInput.value || 0) + 1); });
    minusBtn.addEventListener('click', ()=> { const v = Number(nomorInput.value || 1); if(v>1) nomorInput.value = v-1; });

    // defaults
    tahunInput.value = defaultYear;
    bulanSelect.selectedIndex = defaultMonthIndex;

    // Local storage helpers for last number
    function storageKeyForCombo(kode, sekolah, tahun){ return `surat.last.${kode}::${sekolah}::${tahun}`; }
    function saveLastNumber(kode, sekolah, tahun, nomor){
      if(!kode || !sekolah || !tahun) return;
      try { localStorage.setItem(storageKeyForCombo(kode,sekolah,tahun), String(nomor)); statusSaved.textContent = `Tersimpan: ${kode}/${padTwo(nomor)}/${sekolah}/${bulanSelect.value}/${tahun}`; setTimeout(()=> statusSaved.textContent='',1600); }
      catch(e){}
    }
    function loadLastNumberForCurrentCombo(){
      const kode = selectedKode;
      const sekolah = (sekolahSelect.value === 'LAINNYA' ? (sekolahCustom.value.trim() || 'SD-TIDAK-TERTENTU') : sekolahSelect.value);
      const tahun = String(tahunInput.value || defaultYear);
      if(!kode) return;
      const v = localStorage.getItem(storageKeyForCombo(kode,sekolah,tahun));
      if(v && /^\d+$/.test(v)) nomorInput.value = Number(v);
      else {
        const alt = localStorage.getItem(storageKeyForCombo(kode,sekolah,defaultYear));
        if(alt && /^\d+$/.test(alt)) nomorInput.value = Number(alt);
      }
    }
    // save when nomor changes (debounced)
    let saveTimer = null;
    nomorInput.addEventListener('input', ()=>{ 
      if(saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(()=>{
        if(!selectedKode) return;
        const sekolah = (sekolahSelect.value === 'LAINNYA' ? (sekolahCustom.value.trim() || 'SD-TIDAK-TERTENTU') : sekolahSelect.value);
        saveLastNumber(selectedKode,sekolah,String(tahunInput.value || defaultYear), Number(nomorInput.value || 1));
      }, 500);
    });
    [sekolahCustom, sekolahSelect, tahunInput].forEach(el => el.addEventListener('change', loadLastNumberForCurrentCombo));
    sekolahCustom.addEventListener('input', ()=> { if(sekolahSelect.value==='LAINNYA') loadLastNumberForCurrentCombo(); });

    // =========================
    // History (localStorage + online)
    // =========================
    const HISTORY_KEY = 'surat.history.v1';

    function loadHistory(){
      try{ const raw = localStorage.getItem(HISTORY_KEY); return raw ? JSON.parse(raw) : []; }catch(e){ return []; }
    }
    function saveHistory(arr){ try{ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); }catch(e){} }
    function addHistoryEntry(text){
      const nowIso = new Date().toISOString();
      const id = nowIso + '::' + Math.random().toString(36).slice(2,9);
      const entry = { id, text, created: nowIso };
      const arr = loadHistory();
      arr.unshift(entry);
      if(arr.length > 200) arr.length = 200;
      saveHistory(arr);
      renderHistory();
    }
    function deleteHistoryEntry(id){ let arr = loadHistory(); arr = arr.filter(e=> e.id !== id); saveHistory(arr); renderHistory(); }
    function clearHistory(){ if(!confirm('Hapus semua riwayat lokal? Tindakan ini tidak bisa dibatalkan.')) return; localStorage.removeItem(HISTORY_KEY); renderHistory(); }

    // render history
    function renderHistory(){
      const arr = loadHistory();
      historyContainer.innerHTML = '';
      if(!arr || arr.length === 0){ noHistoryMsg.style.display = 'block'; return; } else noHistoryMsg.style.display = 'none';
      arr.forEach(entry => {
        const div = document.createElement('div'); div.className = 'history-item';
        const left = document.createElement('div'); left.className = 'hist-left';
        const right = document.createElement('div'); right.className = 'hist-right';

        const dt = document.createElement('div'); dt.innerHTML = `<strong>${formatIndoDate(entry.created)}</strong>`;
        const txt = document.createElement('div'); txt.className = 'tiny'; txt.textContent = entry.text;

        left.appendChild(dt); left.appendChild(txt);

        // copy btn
        const copyB = document.createElement('button'); copyB.className = 'btn btn-ghost'; copyB.textContent = 'Copy';
        copyB.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(entry.text); copyB.textContent = '‚úÖ'; setTimeout(()=> copyB.textContent='Copy',900); } catch{ alert('Gagal menyalin.'); } });

        // delete btn
        const delB = document.createElement('button'); delB.className = 'btn btn-muted'; delB.textContent = 'Hapus';
        delB.addEventListener('click', ()=> { if(confirm('Hapus entri ini dari riwayat?')) deleteHistoryEntry(entry.id); });

        // reuse btn
        const reuseB = document.createElement('button'); reuseB.className = 'btn btn-primary'; reuseB.textContent = 'Gunakan';
        reuseB.addEventListener('click', ()=>{
          const parts = entry.text.split('/');
          if(parts.length >= 5){
            const kode = parts[0]; const nomor = parts[1]; const sekolah = parts[2]; const bulan = parts[3]; const tahun = parts[4];
            const found = kodeData.find(k=>k.kode === kode);
            if(found) { renderKodeList(kodeData); selectKode(kode); } else { alert('Kode pada riwayat tidak ditemukan di daftar kode. Pilih manual.'); }
            nomorInput.value = Number(nomor) || 1;
            const opt = Array.from(sekolahSelect.options).find(o=> o.value === sekolah);
            if(opt) { sekolahSelect.value = sekolah; sekolahCustom.style.display='none'; sekolahCustom.value=''; } else { sekolahSelect.value = 'LAINNYA'; sekolahCustom.style.display='block'; sekolahCustom.value = sekolah; }
            const bIndex = Array.from(bulanSelect.options).findIndex(o=> o.value === bulan);
            if(bIndex >= 0) bulanSelect.selectedIndex = bIndex;
            tahunInput.value = tahun || defaultYear;
            const full = entry.text;
            hasilEl.value = full; previewNumber.textContent = full; previewNumberInline.textContent = full; previewKet.textContent = (found ? found.ket : '-'); previewMeta.textContent = `${sekolah} ‚Äî Kode ${kode} (${found ? found.ket : '‚Äî'}) ‚Äî dimuat dari riwayat`; previewCreated.textContent = formatIndoDate(entry.created); previewArea.style.display = 'block';
          } else alert('Format riwayat tidak dikenali.');
        });

        right.appendChild(reuseB); right.appendChild(copyB); right.appendChild(delB);

        div.appendChild(left); div.appendChild(right); historyContainer.appendChild(div);
      });
    }

    // attach clear history
    clearHistoryBtn.addEventListener('click', clearHistory);

// =========================
// Online save/load functions
// =========================
async function saveOnlineHistory(data) {
  try {
    // Gunakan no-cors agar fetch tidak ditolak oleh browser
    const resp = await fetch(API_URL, {
      method: 'POST',
      mode: 'no-cors', // biar tidak gagal karena CORS
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    // Karena mode no-cors, kita tidak bisa membaca response JSON,
    // jadi anggap berhasil kalau tidak error di fetch.
    console.log('‚úÖ Data dikirim ke Google Sheet (mode no-cors)');
    statusSaved.textContent = '‚úÖ Tersimpan ke Google Sheet';
    setTimeout(() => (statusSaved.textContent = ''), 1800);

  } catch (err) {
    console.error('‚ùå Gagal kirim data ke Google Sheet:', err);
    alert('Terjadi kesalahan saat mengirim data: ' + err.message);
  }
}



    async function loadOnlineHistory(){
      try{
        const res = await fetch(API_URL);
        const json = await res.json();
        if(!Array.isArray(json)) return [];
        const mapped = json.map(r => ({ created: r.Tanggal || r.Date || new Date().toISOString(), text: r.Hasil || r.hasil || (Object.values(r)[6]||'') }));
        return mapped.reverse();
      } catch(err){
        console.error('Gagal muat riwayat online:', err);
        return [];
      }
    }

    loadOnlineBtn.addEventListener('click', async ()=>{
      loadOnlineBtn.textContent = 'Memuat...';
      const arr = await loadOnlineHistory();
      if(!arr || arr.length === 0){ alert('Tidak ada riwayat online atau gagal memuat.'); loadOnlineBtn.textContent = 'üîÑ Muat Riwayat Online'; return; }
      const top = arr.slice(0,50);
      const local = loadHistory();
      const existingTexts = new Set(local.map(x=>x.text));
      top.forEach(a => { if(!existingTexts.has(a.text)){ local.unshift({ id: a.created + '::online', text: a.text, created: a.created }); existingTexts.add(a.text); } });
      if(local.length > 200) local.length = 200;
      saveHistory(local);
      renderHistory();
      loadOnlineBtn.textContent = 'üîÑ Muat Riwayat Online';
      alert('Riwayat online dimuat ke cache lokal.');
    });

    // copy all history
    copyAllHistoryBtn.addEventListener('click', async ()=>{
      const arr = loadHistory();
      if(!arr.length) return alert('Belum ada riwayat.');
      const text = arr.map(e => e.text).join('\n');
      try{ await navigator.clipboard.writeText(text); copyAllHistoryBtn.textContent = '‚úÖ Disalin Semua'; setTimeout(()=> copyAllHistoryBtn.textContent='üìã Salin Semua',1200); }catch{ alert('Gagal menyalin semua riwayat.'); }
    });

    // =========================
    // Generate & Preview logic
    // =========================
    function getSelectedSchool(){ return (sekolahSelect.value === 'LAINNYA' ? (sekolahCustom.value.trim() || 'SD-TIDAK-TERTENTU') : sekolahSelect.value); }
    function getSelectedMonth(){ return bulanSelect.value; }
    function validateFields(){ if(!selectedKode) { alert('Pilih kode surat terlebih dahulu.'); return false; } const nomor = Number(nomorInput.value || 0); if(!Number.isFinite(nomor) || nomor < 1) { alert('Nomor surat tidak valid.'); return false; } const tahun = Number(tahunInput.value || 0); if(!Number.isFinite(tahun) || tahun < 1900) { alert('Tahun tidak valid.'); return false; } return true; }
    function buildNomorSurat(){ const kode = selectedKode; const nomor = padTwo(Number(nomorInput.value || 1)); const sekolah = getSelectedSchool(); const bulan = getSelectedMonth(); const tahun = String(tahunInput.value || defaultYear); return `${kode}/${nomor}/${sekolah}/${bulan}/${tahun}`; }
    function updatePreviewAndSave(){
      if(!validateFields()) return;
      const full = buildNomorSurat();
      hasilEl.value = full; previewNumber.textContent = full; previewNumberInline.textContent = full; const found = kodeData.find(k=>k.kode===selectedKode); previewKet.textContent = found ? found.ket : '-'; previewMeta.textContent = `${getSelectedSchool()} ‚Äî Kode ${selectedKode} (${found ? found.ket : '‚Äî'}) ‚Äî dibuat:`; previewCreated.textContent = formatIndoDate(new Date().toISOString()); previewArea.style.display = 'block';
      // save last nomor for combo
      saveLastNumber(selectedKode, getSelectedSchool(), String(tahunInput.value || defaultYear), Number(nomorInput.value || 1));
      // add to local history
      addHistoryEntry(full);
      // send to online sheet
      saveOnlineHistory({ sekolah: getSelectedSchool(), kode: selectedKode, nomor: padTwo(Number(nomorInput.value||1)), bulan: getSelectedMonth(), tahun: tahunInput.value, hasil: full, pembuat: (pembuatInput.value || 'Anon') });
      // increment nomor for convenience
      nomorInput.value = Number(nomorInput.value) + 1;
      saveLastNumber(selectedKode, getSelectedSchool(), String(tahunInput.value || defaultYear), Number(nomorInput.value || 1));
    }

    // generate button
    generateBtn.addEventListener('click', updatePreviewAndSave);

    // copy button
    copyBtn.addEventListener('click', async ()=>{
      if(!hasilEl.value.trim()){ alert('Belum ada hasil. Tekan Generate dulu.'); return; }
      try{ await navigator.clipboard.writeText(hasilEl.value.trim()); copyBtn.textContent = '‚úÖ Disalin'; setTimeout(()=> copyBtn.textContent='Copy',1200); }
      catch{ hasilEl.select(); try { document.execCommand('copy'); copyBtn.textContent = '‚úÖ Disalin'; setTimeout(()=> copyBtn.textContent='Copy',1200); } catch { alert('Gagal menyalin ke clipboard.'); } }
    });

    // reset button (doesn't clear history)
    resetBtn.addEventListener('click', ()=>{
      selectedKode = null; kodeElements.forEach(k=>k.el.classList.remove('kode-selected'));
      kodeDescEl.textContent = 'Pilih kode untuk melihat keterangan.';
      nomorInput.value = 1; sekolahSelect.selectedIndex = 0; sekolahCustom.value=''; sekolahCustom.style.display='none';
      bulanSelect.selectedIndex = defaultMonthIndex; tahunInput.value = defaultYear; hasilEl.value = ''; previewArea.style.display = 'none';
    });

    // initial load
    window.addEventListener('load', ()=>{ if(kodeData.length) selectKode(kodeData[0].kode); renderHistory(); searchEl.focus(); });

  </script>
</body>
</html>

